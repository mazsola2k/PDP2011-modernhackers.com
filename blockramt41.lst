       1                                         .title test41 - terminal test code
       2                                
       3                                ;--
       4                                ;-- Copyright (c) 2008-2019 Sytse van Slooten
       5                                ;--
       6                                ;-- Permission is hereby granted to any person obtaining a copy of these VHDL source files and
       7                                ;-- other language source files and associated documentation files ("the materials") to use
       8                                ;-- these materials solely for personal, non-commercial purposes.
       9                                ;-- You are also granted permission to make changes to the materials, on the condition that this
      10                                ;-- copyright notice is retained unchanged.
      11                                ;--
      12                                ;-- The materials are distributed in the hope that they will be useful, but WITHOUT ANY WARRANTY;
      13                                ;-- without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
      14                                ;--
      15 000000 000167  000774                   jmp t40
      16                                ;         .word 0   ;                    0
      17                                ;         .word 0   ;                    2
      18 000004 000000                           .word 0   ;                    4
      19 000006 000000                           .word 0   ;                    6
      20 000010 000000                           .word 0   ;                   10
      21 000012 000000                           .word 0   ;                   12
      22 000014 000000                           .word 0   ;                   14
      23 000016 000000                           .word 0   ;                   16
      24 000020 000000                           .word 0   ;                   20
      25 000022 000000                           .word 0   ;                   22
      26 000024 000000                           .word 0   ;                   24
      27 000026 000000                           .word 0   ;                   26
      28 000030 000000                           .word 0   ;                   30
      29 000032 000000                           .word 0   ;                   32
      30 000034 000000                           .word 0   ;                   34
      31 000036 000000                           .word 0   ;                   36
      32 000040 000000                           .word 0   ;                   40
      33 000042 000000                           .word 0   ;                   42
      34 000044 000000                           .word 0   ;                   44
      35 000046 000000                           .word 0   ;                   46
      36 000050 000000                           .word 0   ;                   50
      37 000052 000000                           .word 0   ;                   52
      38 000054 000000                           .word 0   ;                   54
      39 000056 000000                           .word 0   ;                   56
      40 000060 000000                           .word 0   ;                   60
      41 000062 000000                           .word 0   ;                   62
      42 000064 000000                           .word 0   ;                   64
      43 000066 000000                           .word 0   ;                   66
      44 000070 000000                           .word 0   ;                   70
      45 000072 000000                           .word 0   ;                   72
      46 000074 000000                           .word 0   ;                   74
      47 000076 000000                           .word 0   ;                   76
      48 000100 000000                           .word 0   ;                  100
      49 000102 000000                           .word 0   ;                  102
      50 000104 000000                           .word 0   ;                  104
      51 000106 000000                           .word 0   ;                  106
      52 000110 000000                           .word 0   ;                  110
      53 000112 000000                           .word 0   ;                  112
      54 000114 000000                           .word 0   ;                  114
      55 000116 000000                           .word 0   ;                  116
      56 000120 000000                           .word 0   ;                  120
      57 000122 000000                           .word 0   ;                  122
      58 000124 000000                           .word 0   ;                  124
      59 000126 000000                           .word 0   ;                  126
      60 000130 000000                           .word 0   ;                  130
      61 000132 000000                           .word 0   ;                  132
      62 000134 000000                           .word 0   ;                  134
      63 000136 000000                           .word 0   ;                  136
      64 000140 000000                           .word 0   ;                  140
      65 000142 000000                           .word 0   ;                  142
      66 000144 000000                           .word 0   ;                  144
      67 000146 000000                           .word 0   ;                  146
      68 000150 000000                           .word 0   ;                  150
      69 000152 000000                           .word 0   ;                  152
      70 000154 000000                           .word 0   ;                  154
      71 000156 000000                           .word 0   ;                  156
      72 000160 000000                           .word 0   ;                  160
      73 000162 000000                           .word 0   ;                  162
      74 000164 000000                           .word 0   ;                  164
      75 000166 000000                           .word 0   ;                  166
      76 000170 000000                           .word 0   ;                  170
      77 000172 000000                           .word 0   ;                  172
      78 000174 000000                           .word 0   ;                  174
      79 000176 000000                           .word 0   ;                  176
      80 000200 000000                           .word 0   ;                  200
      81 000202 000000                           .word 0   ;                  202
      82 000204 000000                           .word 0   ;                  204
      83 000206 000000                           .word 0   ;                  206
      84 000210 000000                           .word 0   ;                  210
      85 000212 000000                           .word 0   ;                  212
      86 000214 000000                           .word 0   ;                  214
      87 000216 000000                           .word 0   ;                  216
      88 000220 000000                           .word 0   ;                  220
      89 000222 000000                           .word 0   ;                  222
      90 000224 000000                           .word 0   ;                  224
      91 000226 000000                           .word 0   ;                  226
      92 000230 000000                           .word 0   ;                  230
      93 000232 000000                           .word 0   ;                  232
      94 000234 000000                           .word 0   ;                  234
      95 000236 000000                           .word 0   ;                  236
      96 000240 000000                           .word 0   ;                  240
      97 000242 000000                           .word 0   ;                  242
      98 000244 000000                           .word 0   ;                  244
      99 000246 000000                           .word 0   ;                  246
     100 000250 000000                           .word 0   ;                  250
     101 000252 000000                           .word 0   ;                  252
     102 000254 000000                           .word 0   ;                  254
     103 000256 000000                           .word 0   ;                  256
     104 000260 000000                           .word 0   ;                  260
     105 000262 000000                           .word 0   ;                  262
     106 000264 000000                           .word 0   ;                  264
     107 000266 000000                           .word 0   ;                  266
     108 000270 000000                           .word 0   ;                  270
     109 000272 000000                           .word 0   ;                  272
     110 000274 000000                           .word 0   ;                  274
     111 000276 000000                           .word 0   ;                  276
     112 000300 000000                           .word 0   ;                  300
     113 000302 000000                           .word 0   ;                  302
     114 000304 000000                           .word 0   ;                  304
     115 000306 000000                           .word 0   ;                  306
     116 000310 000000                           .word 0   ;                  310
     117 000312 000000                           .word 0   ;                  312
     118 000314 000000                           .word 0   ;                  314
     119 000316 000000                           .word 0   ;                  316
     120 000320 000000                           .word 0   ;                  320
     121 000322 000000                           .word 0   ;                  322
     122 000324 000000                           .word 0   ;                  324
     123 000326 000000                           .word 0   ;                  326
     124 000330 000000                           .word 0   ;                  330
     125 000332 000000                           .word 0   ;                  332
     126 000334 000000                           .word 0   ;                  334
     127 000336 000000                           .word 0   ;                  336
     128 000340 000000                           .word 0   ;                  340
     129 000342 000000                           .word 0   ;                  342
     130 000344 000000                           .word 0   ;                  344
     131 000346 000000                           .word 0   ;                  346
     132 000350 000000                           .word 0   ;                  350
     133 000352 000000                           .word 0   ;                  352
     134 000354 000000                           .word 0   ;                  354
     135 000356 000000                           .word 0   ;                  356
     136 000360 000000                           .word 0   ;                  360
     137 000362 000000                           .word 0   ;                  362
     138 000364 000000                           .word 0   ;                  364
     139 000366 000000                           .word 0   ;                  366
     140 000370 000000                           .word 0   ;                  370
     141 000372 000000                           .word 0   ;                  372
     142 000374 000000                           .word 0   ;                  374
     143 000376 000000                           .word 0   ;                  376
     144 000400 000000                           .word 0   ;                  400
     145 000402 000000                           .word 0   ;                  402
     146 000404 000000                           .word 0   ;                  404
     147 000406 000000                           .word 0   ;                  406
     148 000410 000000                           .word 0   ;                  410
     149 000412 000000                           .word 0   ;                  412
     150 000414 000000                           .word 0   ;                  414
     151 000416 000000                           .word 0   ;                  416
     152 000420 000000                           .word 0   ;                  420
     153 000422 000000                           .word 0   ;                  422
     154 000424 000000                           .word 0   ;                  424
     155 000426 000000                           .word 0   ;                  426
     156 000430 000000                           .word 0   ;                  430
     157 000432 000000                           .word 0   ;                  432
     158 000434 000000                           .word 0   ;                  434
     159 000436 000000                           .word 0   ;                  436
     160 000440 000000                           .word 0   ;                  440
     161 000442 000000                           .word 0   ;                  442
     162 000444 000000                           .word 0   ;                  444
     163 000446 000000                           .word 0   ;                  446
     164 000450 000000                           .word 0   ;                  450
     165 000452 000000                           .word 0   ;                  452
     166 000454 000000                           .word 0   ;                  454
     167 000456 000000                           .word 0   ;                  456
     168 000460 000000                           .word 0   ;                  460
     169 000462 000000                           .word 0   ;                  462
     170 000464 000000                           .word 0   ;                  464
     171 000466 000000                           .word 0   ;                  466
     172 000470 000000                           .word 0   ;                  470
     173 000472 000000                           .word 0   ;                  472
     174 000474 000000                           .word 0   ;                  474
     175 000476 000000                           .word 0   ;                  476
     176 000500 000000                           .word 0   ;                  500
     177 000502 000000                           .word 0   ;                  502
     178 000504 000000                           .word 0   ;                  504
     179 000506 000000                           .word 0   ;                  506
     180 000510 000000                           .word 0   ;                  510
     181 000512 000000                           .word 0   ;                  512
     182 000514 000000                           .word 0   ;                  514
     183 000516 000000                           .word 0   ;                  516
     184 000520 000000                           .word 0   ;                  520
     185 000522 000000                           .word 0   ;                  522
     186 000524 000000                           .word 0   ;                  524
     187 000526 000000                           .word 0   ;                  526
     188 000530 000000                           .word 0   ;                  530
     189 000532 000000                           .word 0   ;                  532
     190 000534 000000                           .word 0   ;                  534
     191 000536 000000                           .word 0   ;                  536
     192 000540 000000                           .word 0   ;                  540
     193 000542 000000                           .word 0   ;                  542
     194 000544 000000                           .word 0   ;                  544
     195 000546 000000                           .word 0   ;                  546
     196 000550 000000                           .word 0   ;                  550
     197 000552 000000                           .word 0   ;                  552
     198 000554 000000                           .word 0   ;                  554
     199 000556 000000                           .word 0   ;                  556
     200 000560 000000                           .word 0   ;                  560
     201 000562 000000                           .word 0   ;                  562
     202 000564 000000                           .word 0   ;                  564
     203 000566 000000                           .word 0   ;                  566
     204 000570 000000                           .word 0   ;                  570
     205 000572 000000                           .word 0   ;                  572
     206 000574 000000                           .word 0   ;                  574
     207 000576 000000                           .word 0   ;                  576
     208 000600 000000                           .word 0   ;                  600
     209 000602 000000                           .word 0   ;                  602
     210 000604 000000                           .word 0   ;                  604
     211 000606 000000                           .word 0   ;                  606
     212 000610 000000                           .word 0   ;                  610
     213 000612 000000                           .word 0   ;                  612
     214 000614 000000                           .word 0   ;                  614
     215 000616 000000                           .word 0   ;                  616
     216 000620 000000                           .word 0   ;                  620
     217 000622 000000                           .word 0   ;                  622
     218 000624 000000                           .word 0   ;                  624
     219 000626 000000                           .word 0   ;                  626
     220 000630 000000                           .word 0   ;                  630
     221 000632 000000                           .word 0   ;                  632
     222 000634 000000                           .word 0   ;                  634
     223 000636 000000                           .word 0   ;                  636
     224 000640 000000                           .word 0   ;                  640
     225 000642 000000                           .word 0   ;                  642
     226 000644 000000                           .word 0   ;                  644
     227 000646 000000                           .word 0   ;                  646
     228 000650 000000                           .word 0   ;                  650
     229 000652 000000                           .word 0   ;                  652
     230 000654 000000                           .word 0   ;                  654
     231 000656 000000                           .word 0   ;                  656
     232 000660 000000                           .word 0   ;                  660
     233 000662 000000                           .word 0   ;                  662
     234 000664 000000                           .word 0   ;                  664
     235 000666 000000                           .word 0   ;                  666
     236 000670 000000                           .word 0   ;                  670
     237 000672 000000                           .word 0   ;                  672
     238 000674 000000                           .word 0   ;                  674
     239 000676 000000                           .word 0   ;                  676
     240 000700 000000                           .word 0   ;                  700
     241 000702 000000                           .word 0   ;                  702
     242 000704 000000                           .word 0   ;                  704
     243 000706 000000                           .word 0   ;                  706
     244 000710 000000                           .word 0   ;                  710
     245 000712 000000                           .word 0   ;                  712
     246 000714 000000                           .word 0   ;                  714
     247 000716 000000                           .word 0   ;                  716
     248 000720 000000                           .word 0   ;                  720
     249 000722 000000                           .word 0   ;                  722
     250 000724 000000                           .word 0   ;                  724
     251 000726 000000                           .word 0   ;                  726
     252 000730 000000                           .word 0   ;                  730
     253 000732 000000                           .word 0   ;                  732
     254 000734 000000                           .word 0   ;                  734
     255 000736 000000                           .word 0   ;                  736
     256 000740 000000                           .word 0   ;                  740
     257 000742 000000                           .word 0   ;                  742
     258 000744 000000                           .word 0   ;                  744
     259 000746 000000                           .word 0   ;                  746
     260 000750 000000                           .word 0   ;                  750
     261 000752 000000                           .word 0   ;                  752
     262 000754 000000                           .word 0   ;                  754
     263 000756 000000                           .word 0   ;                  756
     264 000760 000000                           .word 0   ;                  760
     265 000762 000000                           .word 0   ;                  762
     266 000764 000000                           .word 0   ;                  764
     267 000766 000000                           .word 0   ;                  766
     268 000770 000000                           .word 0   ;                  770
     269 000772 000000                           .word 0   ;                  772
     270 000774 000000                           .word 0   ;                  774
     271                                stbot:
     272                                stk:
     273 000776 000000                           .word 0   ;                  776
     274                                ;
     275                                ; misc definitions
     276                                ;
     277 000011                         ht       = 11
     278 000012                         lf       = 12
     279 000015                         cr       = 15
     280 177776                         ps       = 177776
     281 177774                         stklmt   = 177774
     282 177772                         pirq     = 177772
     283                                ;
     284                                ; general purpose register definitions
     285                                ;
     286 000000                         r0       = %0
     287 000001                         r1       = %1
     288 000002                         r2       = %2
     289 000003                         r3       = %3
     290 000004                         r4       = %4
     291 000005                         r5       = %5
     292 000006                         r6       = %6
     293 000007                         r7       = %7
     294 000006                         sp       = %6
     295 000007                         pc       = %7
     296                                ;
     297                                ; start of test
     298                                ;
     299                                t40:
     300 001000 012706  001000                   mov #1000,sp
     301                                
     302 001004 012703  100000                   mov #100000,r3
     303                                1$:
     304 001010 112723  000040                   movb #40,(r3)+              ; fill the buffer with spaces
     305 001014 020327  106300                   cmp r3,#106300              ; this value is 64. past the end of the visible area, and causes to show if the top line of the next row is off.
     306 001020 001373                           bne 1$
     307                                
     308 001022 012702  001262                   mov #hello,r2
     309 001026 012703  100000                   mov #100000,r3
     310                                2$:
     311 001032 112223                           movb (r2)+,(r3)+
     312 001034 001376                           bne 2$
     313 001036 112743  000040                   movb #40,-(r3)
     314                                
     315 001042 012703  100240                   mov #100240,r3
     316                                4$:
     317 001046 010337  140000                   mov r3,@#140000
     318                                
     319 001052 105737  150000                   tstb @#150000            ; poll ps2
     320 001056 100003                           bpl 44$
     321 001060 113700  150002                   movb @#150002,r0
     322 001064 000407                           br 444$
     323                                44$:
     324 001066 105737  177560                   tstb @#177560            ; poll slu
     325 001072 100365                           bpl 4$                   ; positive means ready bit is not set
     326                                
     327 001074 113700  177562                   movb @#177562,r0
     328 001100 142700  000200                   bicb #200,r0             ; vt is a 7-bit terminal... apparently
     329                                
     330                                444$:
     331 001104 120027  000015                   cmpb r0,#15              ; cr
     332 001110 001017                           bne 6$
     333 001112 012701  100000                   mov #100000,r1
     334                                5$:
     335 001116 062701  000120                   add #120,r1
     336 001122 020103                           cmp r1,r3
     337 001124 003774                           ble 5$
     338 001126 162701  000120                   sub #120,r1
     339 001132 020127  100000                   cmp r1,#100000
     340 001136 002002                           bge 55$
     341 001140 012701  100000                   mov #100000,r1
     342                                55$:
     343 001144 010103                           mov r1,r3
     344 001146 000737                           br 4$
     345                                6$:
     346 001150 120027  000012                   cmpb r0,#12              ; lf
     347 001154 001003                           bne 7$
     348 001156 062703  000120                   add #120,r3
     349 001162 000411                           br 99$
     350                                7$:
     351 001164 120027  000000                   cmpb r0,#0               ; null
     352 001170 001001                           bne 8$
     353 001172 000725                           br 4$
     354                                8$:
     355 001174 120027  000177                   cmpb r0,#177             ; del
     356 001200 001001                           bne 9$
     357 001202 000721                           br 4$
     358                                9$:
     359 001204 110023                           movb r0,(r3)+
     360                                99$:
     361 001206 020327  106200                   cmp r3,#106200
     362 001212 002715                           blt 4$
     363 001214 012701  100120                   mov #100120,r1
     364 001220 012702  100000                   mov #100000,r2
     365 001224 012704  106200                   mov #106200,r4
     366                                100$:
     367 001230 012122                           mov (r1)+,(r2)+
     368 001232 020104                           cmp r1,r4
     369 001234 001375                           bne 100$
     370                                101$:
     371 001236 112722  000040                   movb #40,(r2)+
     372 001242 020204                           cmp r2,r4
     373 001244 001374                           bne 101$
     374 001246 012703  106060                   mov #106060,r3
     375 001252 020027  000012                   cmp r0,#12
     376 001256 001346                           bne 8$                ; if we scrolled for anything but lf, redo the last store
     377 001260 000672                           br 4$
     378                                
     379                                400$:
     380                                
     381 001262    110     145     154  hello:   .asciz /Hello, world: vt-cpu t41                                                                        /
         001265    154     157     054  
         001270    040     167     157  
         001273    162     154     144  
         001276    072     040     166  
         001301    164     055     143  
         001304    160     165     040  
         001307    164     064     061  
         001312    040     040     040  
         001315    040     040     040  
         001320    040     040     040  
         001323    040     040     040  
         001326    040     040     040  
         001331    040     040     040  
         001334    040     040     040  
         001337    040     040     040  
         001342    040     040     040  
         001345    040     040     040  
         001350    040     040     040  
         001353    040     040     040  
         001356    040     040     040  
         001361    040     040     040  
         001364    040     040     040  
         001367    040     040     040  
         001372    040     040     040  
         001375    040     040     040  
         001400    040     040     040  
         001403    040     040     040  
         001406    040     040     040  
         001411    040     040     040  
         001414    040     040     040  
         001417    040     040     040  
         001422    000                  
     382 001423    110     145     154  hello2:  .asciz /Hello, world: vt-cpu t41 line2                                                                  /
         001426    154     157     054  
         001431    040     167     157  
         001434    162     154     144  
         001437    072     040     166  
         001442    164     055     143  
         001445    160     165     040  
         001450    164     064     061  
         001453    040     154     151  
         001456    156     145     062  
         001461    040     040     040  
         001464    040     040     040  
         001467    040     040     040  
         001472    040     040     040  
         001475    040     040     040  
         001500    040     040     040  
         001503    040     040     040  
         001506    040     040     040  
         001511    040     040     040  
         001514    040     040     040  
         001517    040     040     040  
         001522    040     040     040  
         001525    040     040     040  
         001530    040     040     040  
         001533    040     040     040  
         001536    040     040     040  
         001541    040     040     040  
         001544    040     040     040  
         001547    040     040     040  
         001552    040     040     040  
         001555    040     040     040  
         001560    040     040     040  
         001563    000                  
     382                                
